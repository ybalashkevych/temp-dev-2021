# CI Scripts

Python scripts used by GitHub Actions workflows for PR validation.

## Scripts

### `calculate_coverage.py`

Calculates code coverage from Xcode's xcresult bundle.

**Usage:**
```bash
python3 calculate_coverage.py <threshold>
```

**Input:**
- `coverage.json` - Generated by `xcrun xccov view --report --json`
- `<threshold>` - Minimum required coverage percentage

**Output:**
- `coverage_result.txt` - Coverage percentage (e.g., "85.50")
- `coverage_status.txt` - "PASSED" or "FAILED"

**Exclusions:**
- SwiftUI Views (except ViewModels)
- Components
- Models
- App setup files
- Test files
- Generated files

### `report_pr_results.py`

Generates markdown comment for PR validation results.

**Usage:**
```bash
python3 report_pr_results.py
```

**Input:**
- `swiftlint-output.txt` - SwiftLint results
- `swiftformat-output.txt` - swift-format results
- `coverage_result.txt` - Coverage percentage
- `coverage_status.txt` - Coverage status
- Environment variables:
  - `TESTS_FAILED` - "true" if tests failed
  - `TEST_ERRORS` - Test error output
  - `COVERAGE_THRESHOLD` - Required coverage percentage
  - `GITHUB_*` - GitHub Actions context

**Output:**
- `pr-comment.md` - Formatted markdown comment for PR

## Local Testing

```bash
# Test coverage calculation
cd /path/to/project
xcrun xccov view --report --json TestResults.xcresult > coverage.json
python3 scripts/ci/calculate_coverage.py 20.0

# Test PR comment generation
export COVERAGE_THRESHOLD=20.0
export TESTS_FAILED=false
python3 scripts/ci/report_pr_results.py
cat pr-comment.md
```

## Integration

These scripts are used by `.github/workflows/pr-checks.yml` to:
1. Calculate code coverage with proper exclusions
2. Generate formatted PR comments with all validation results
3. Post/update comments on pull requests

## Benefits

- ✅ **Testable** - Run scripts locally before pushing
- ✅ **Maintainable** - Python is easier to debug than embedded bash
- ✅ **Reliable** - Proper error handling prevents workflow crashes
- ✅ **Reusable** - Can be used in other contexts

